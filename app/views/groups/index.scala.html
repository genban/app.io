@(pager: Pager)(
implicit req: UserRequest[_], lang: Lang)

@import common._
@import helper._

@layouts.base(Groups.vmsg("title")) {

  @ng._alert()

  <div class="row" style="margin-top:10px">
    <h2 style="margin-left: 20px">
      <i class="fa fa-group fa-lg fa-fw"></i>
      @Groups.vmsg("head")
    </h2>
  </div>

  <div ng-controller="GroupsCtrl">

    @ng._msg_confirm_delete("html")

    <div class="row">
      <div class="table-responsive">
        <table class="table table-hover table-ellipsis">
          <thead>
            <tr>
              <th class="hidden-xs col-sm-4">
                @MSG("id")
              </th>
              <th class="col-xs-7 col-sm-3">
                @MSG("name")
              </th>
              <th class="hidden-xs col-sm-2">
                @MSG("description")
              </th>
              <th class="col-xs-2  col-sm-1 text-right">
                @MSG("action")
              </th>
            </tr>
          </thead>
          <tbody>
            <tr class="ng-cloak" ng-repeat="grp in GroupList.groups">
              <td class="hidden-xs">
                <a ng-href="{{jsRoutes.controllers.Groups.show(grp.id).url}}">
                  <code>{{ grp.id }}</code>
                </a>
              </td>

              <td>
                <a ng-href="{{jsRoutes.controllers.Groups.show(grp.id).url}}" class="hidden-sm hidden-md hidden-lg">
                  <i class="fa fa-info-circle fa-lg text-info"></i>
                </a>

                <a href="#" editable-text="grp.name" buttons="no"
                onbeforesave="checkName($data)"
                onaftersave="grp.$save()">
                  {{ grp.name }}
                </a>
              </td>

              <td class="hidden-xs">
                {{ grp.description }}
              </td>
              <td>
                <button type="button" class="btn btn-danger btn-xs pull-right"
                  ng-show="!grp.is_internal"
                  ng-click="confirm(grp)">
                  <i class="fa fa-trash"></i>
                  @MSG("delete")
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-12">
        <form name="form" class="form-inline" novalidate>

          @ng._form_control("name",
            'maxLength    -> 64,
            'minLength    -> 2,
            'tabindex     -> 1,
            'placeholder  -> Groups.vmsg("name.placeholder"),
            'autocomplete -> "off",
            Symbol("ng-model") -> "group.name"
          )

          @ng._form_control("description",
            'tabindex    -> 2,
            'placeholder -> Groups.vmsg("description.placeholder"),
            Symbol("ng-model") -> "group.description"
          )

          <button type="submit" class="btn btn-success" ng-click="GroupList.create(group)" ng-disabled="form.$invalid || !group.name || group.name === ''">
            <i class="fa fa-plus"></i>
            @Groups.vmsg("new.group")
          </button>
        </form>
      </div>
    </div>

    <div class="row">
      @ng._pager("GroupList.links")
    </div>
  </div>
}(
  libs.webjars("css", "xeditable")
)(
  libs.webjars("js", "angular-resource"),
  libs.webjars("js", "xeditable"),
  libs.assets("js", "api"),
  libs.assets("js", "ui.parts"),
  ng._msg_confirm_delete("js"),
  jsRoutes,
  controller
)

@jsRoutes = {
  @helper.javascriptRouter("jsRoutes")(
    routes.javascript.Groups.show
  )
}

@controller = {
  <script>
    var list = angular.module('groups.list',
      ['xeditable', 'api.group', 'api.helper', 'ui.parts']);

    list.run(function(editableOptions) {
      editableOptions.theme = 'bs3';
    });

    list.factory('GroupList',
      ['Group', 'LinkHeader', 'Alert',
      function(Group, LinkHeader, Alert){
        var service = {};
        service.links = LinkHeader.links;

        service.groups = Group.query({
          page     :@pager.pageNum,
          per_page :@pager.pageSize
          }, function(value, headers){
            LinkHeader.updateLinks(
              '@Html(routes.Groups.index(pager.next).toString)',
              '@Html(routes.Groups.index(pager.prev).toString)',
              headers);
          });

        service.create = function(data) {
          new Group(data).$save(function(value){
            service.groups.push(value);
          });
        };

        service.delete = function(data) {
          data.$delete(
            function(){
              var idx = service.groups.indexOf(data);
              service.groups.splice(idx, 1);
            },
            function(res){
              Alert.push({type:'danger', msg:res.data.message});
          });
        };

        return service;
    }]);

    list.controller('GroupsCtrl',
      ['$scope', '$http', '$q', '$modal', 'ClientError', 'GroupList',
      function($scope, $http, $q, $modal, ClientError, GroupList) {
        $scope.GroupList = GroupList;
        $scope.jsRoutes  = jsRoutes;

        $scope.checkName = function(data) {
          var d = $q.defer();
          $http.post('@routes.Groups.checkName', {name:data})
            .success(function(res){
              d.resolve();
            })
            .error(function(data, status) {
              d.resolve(ClientError.firstMsg(data, status));
            });
          return d.promise;
        };

        $scope.confirm = function(grp) {

          var instance = openConfirmDelete($modal);

          instance.result.then(function() {
            GroupList.delete(grp);
          }, function () {
          });
        };
    }]);

    addConfirmDeleteCtrl(list);

    angular.module('app').requires.push('groups.list');
  </script>
}