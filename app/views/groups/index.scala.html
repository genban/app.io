@(pager: Pager, fm: Form[_])(
implicit req: UserRequest[_], lang: Lang)

@import common._
@import helper._

@layouts.base(Groups.vmsg("title")) {

  @common._flashing()

  <div ng-controller="AlertCtrl">
    <alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert>
  </div>

  <div class="row" style="margin-top:10px">
    <h2 style="margin-left: 20px">
      <i class="fa fa-group fa-lg fa-fw"></i>
      @Groups.vmsg("head")
    </h2>
  </div>

  <div ng-controller="NewEntryCtrl">
    <div class="row">
      <button class="btn btn-success pull-right"
              ng-click="isCollapsed = !isCollapsed">
        <i class="fa fa-plus fa-lg"></i>
        @MSG("new.entry")
      </button>
    </div>

    <div collapse="isCollapsed" class="row" style="margin-top:10px;">
      <div class="panel panel-default">

        <div class="panel-body">

          <form name="form" novalidate>
            <div class="row">
              <div class="col-xs-12 col-sm-6">
                @{_input_text(fm("name"),
                  '_label     -> MSG("name"),
                  'tabindex   -> 1,
                  'required  -> true,
                  'minLength -> 2,
                  'maxLength -> 64,
                  Symbol("ng-model") -> "group.name"
                  )(ng._fc_form_group)
                }
              </div>

              <div class="col-xs-12 col-sm-6">
                @{_input_text(fm("description"),
                  '_label    -> MSG("description"),
                  'tabindex  -> 2,
                  Symbol("ng-model") -> "group.description"
                  )(ng._fc_form_group)
                }
              </div>
            </div>

            <button type="submit" class="btn btn-success" tabindex="3"
              ng-disabled="form.$invalid"
              ng-click="GroupList.create(group)">
              <i class="fa fa-save fa-lg"></i>
              @MSG("create")
            </button>
          </form>
        </div>
      </div>
    </div>

  </div>


  <div class="row">
    <div class="table-responsive" ng-controller="GroupsCtrl">
      <table class="table table-hover table-ellipsis">
        <thead>
          <tr>
            <th class="col-xs-6 col-sm-5">
              @MSG("id")
            </th>
            <th class="col-xs-4 col-sm-3">
              @MSG("name")
            </th>
            <th class="hidden-xs col-sm-2">
              @MSG("description")
            </th>
            <th class="col-xs-2  col-sm-1 text-right">
              @MSG("action")
            </th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="grp in GroupList.groups">
            <td>
              <a ng-href="{{jsRoutes.controllers.Groups.show(grp.id).url}}">
                <code>{{ grp.id }}</code>
              </a>
            </td>
            <td>
              <a href="#" editable-text="grp.name" buttons="no"
              onbeforesave="checkName($data)"
              onaftersave="grp.$save()">
                {{ grp.name }}
              </a>
            </td>
            <td class="hidden-xs">
              {{ grp.description }}
            </td>
            <td>
              <button type="button" class="btn btn-danger btn-xs pull-right"
                ng-show="!grp.is_internal"
                ng-click="GroupList.delete(grp)">
                <i class="fa fa-trash"></i>
                @MSG("delete")
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <nav>
        <ul class="pager">
          <li class="previous"
            ng-class="GroupList.links.has('prev') ? '' : 'disabled'">
            <a ng-href="{{GroupList.links.prev}}">
              <i class="fa fa-long-arrow-left"></i>
              @MSG("previous")
            </a>
          </li>
          <li class="next"
            ng-class="GroupList.links.has('next') ? '' : 'disabled'">
            <a ng-href="{{GroupList.links.next}}">
              @MSG("next")
              <i class="fa fa-long-arrow-right"></i>
            </a>
          </li>
        </ul>
      </nav>

    </div>
  </div>
}(
  libs.webjars("css", "xeditable")
)(
  libs.webjars("js", "xeditable"),
  libs.webjars("js", "angular-resource"),
  libs.assets("js", "api"),
  jsRoutes,
  controller
)

@jsRoutes = {
  @helper.javascriptRouter("jsRoutes")(
    routes.javascript.Groups.show
  )
}

@controller = {
  <script>
    var list = angular.module('groups.list',
      ["xeditable", 'api.group', 'api.helper']);

    list.run(function(editableOptions) {
      editableOptions.theme = 'bs3';
    });

    list.factory('GroupList',
      ['Group', 'LinkHeader', 'Alerts',
      function(Group, LinkHeader, Alerts){
        var service = {};

        service.links = {
          prev: '@Html(routes.Groups.index(pager.prev).toString)',
          next: '@Html(routes.Groups.index(pager.next).toString)',
          has : function(rel) {
            return rel in this && this[rel] !== "";
          }
        };

        service.groups = Group.query({
          page     :@pager.pageNum,
          per_page :@pager.pageSize
          }, function(value, headers){
            var links = LinkHeader.parse(headers);
            if (!links.has('next')) {service.links.next = ''};
            if (!links.has('prev')) {service.links.prev = ''};
          });

        service.create = function(data) {
          new Group(data).$save(function(value){
            service.groups.unshift(value);
          });
        };

        service.delete = function(data) {
          data.$delete(
            function(){
              var idx = service.groups.indexOf(data);
              service.groups.splice(idx, 1);
            },
            function(res){
              Alerts.push({type:'danger', msg:res.data.message});
          });
        };

        return service;
    }])
    .factory('Alerts', [
      function() {
        return [];
    }]);

    list.controller('GroupsCtrl',
      ['$scope', '$http', '$q', 'ClientError', 'GroupList',
      function ($scope, $http, $q, ClientError, GroupList) {
        $scope.GroupList = GroupList;
        $scope.jsRoutes  = jsRoutes;

        $scope.urlShow = function(id) {
          return jsRoutes.controllers.Groups.show(id).url;
        };

        $scope.checkName = function(data) {
          var d = $q.defer();
          $http.post('@routes.Groups.checkName', {name:data})
            .success(function(res){
              d.resolve();
            })
            .error(function(data, status) {
              d.resolve(ClientError.firstMsg(data, status));
            });
          return d.promise;
        };
    }])
    .controller('NewEntryCtrl',
      ['$scope', 'GroupList',
      function ($scope, GroupList) {
        $scope.GroupList  = GroupList;

        $scope.isCollapsed = @(!fm.hasErrors);
    }])
    .controller('AlertCtrl',
      ['$scope', 'Alerts',
      function ($scope, Alerts) {
      $scope.alerts = Alerts;

      $scope.closeAlert = function(index) {
        $scope.alerts.splice(index, 1);
      };
    }]);

    angular.module('app').requires.push('groups.list');
  </script>
}