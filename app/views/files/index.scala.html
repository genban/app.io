@(path:Path, page: Page[INode])(
implicit req: UserRequest[_], lang: Lang)

@import common._
@import helper._

@home = @{req.user.id.toString}

@layouts.base(Files.vmsg("title")) {

  @ng._alert()

  <div class="row">
    @{_breadcrumb(path)}
  </div>

  <div ng-controller="FilesCtrl">
    <div class="row">
      <div class="table-responsive">
        <table class="table table-hover table-ellipsis">
          <thead>
            <tr>
              <th class="col-xs-5">@MSG("name")</th>
              <th class="col-xs-2 text-right">@MSG("size")</th>
              <th class="col-xs-3 text-right hidden-xs hidden-sm">
                @MSG("created_at")
              </th>
              <th class="col-xs-2 text-right">@MSG("action")</th>
            </tr>
          </thead>
          <tbody>
            @page.map {
              case d: Directory if d.name == "." => {
              }
              case d: Directory => {
                <tr>
                  <td>
                    <i class="fa fa-2x fa-folder fa-fw text-info"></i>
                    <a href="@routes.Files.index(path / d.name)">
                      @d.name
                    </a>
                  </td>
                  <td></td>
                  <td class="hidden-xs hidden-sm"></td>
                  <td></td>
                </tr>
              }

              case f: File => {
                <tr>
                  <td>
                    <i class="fa fa-2x @f.icon fa-fw"></i>
                    @if(f.pdf.?) {
                      <a href="@api.routes.Files.download(path + f.name, true)">
                        @f.name
                      </a>
                    } else {
                      <a href="@routes.Files.show(path + f.name)">
                        @f.name
                      </a>
                    }
                  </td>
                  <td class="text-right">
                    @f.size_pp
                  </td>
                  <td class="text-right hidden-xs hidden-sm">
                    @f.created_at.toString(MSG("datetime.format"))
                  </td>

                  <td>
                    <div class="btn-toolbar pull-right">
                      <div class="btn-group">
                        <a href="@api.routes.Files.download(home /: path + f.name)">
                          <i class="fa fa-download fa-lg"></i>
                        </a>
                      </div>
                      <div class="btn-group">
                        @form(api.routes.Files.destroy(path + f.name), 'class -> "form-inline") {
                          @common._previous_uri()
                          <button type="submit" class="btn form-inline-btn">
                            <i class="fa fa-trash-o fa-lg text-danger"></i>
                          </button>
                        }
                      </div>
                    </div>
                  </td>
                </tr>
              }
            }
            <tr class="ng-cloak" ng-repeat="file in FileList.files">
              <!-- Directory -->
              <td ng-if="file.is_directory">
                <i class="fa fa-2x fa-folder fa-fw text-info"></i>
                <a ng-href="{{jsRoutes.controllers.Files.index(path.append(file.name)).url}}">
                  {{ file.name }}
                </a>
              </td>
              <td ng-if="file.is_directory">
              </td>
              <td ng-if="file.is_directory" class="text-right hidden-xs hidden-sm">
              </td>
              <td ng-if="file.is_directory">
              </td>

              <!-- File -->
              <td ng-if="!file.is_directory">
                <i class="fa fa-2x fa-file-o fa-fw"></i>
                <a ng-href="{{jsRoutes.controllers.Files.show(path.set(file.name)).url}}">
                  {{ file.name }}
                </a>
              </td>
              <td ng-if="!file.is_directory" class="text-right">
                {{ file.size }}
              </td>
              <td ng-if="!file.is_directory" class="text-right hidden-xs hidden-sm">
                {{ file.created_at }}
              </td>
              <td ng-if="!file.is_directory">
                <div class="btn-toolbar pull-right">
                  <div class="btn-group">
                    <a ng-href="{{jsRoutes.controllers.api.Files.download(file.path).url}}">
                      <i class="fa fa-download fa-lg"></i>
                    </a>
                  </div>
                  <div class="btn-group">
                    <i class="fa fa-trash fa-lg"></i>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        @{_pager(page, p => routes.Files.index(path, p))}
      </div>
    </div>
  </div>

  <div class="row">
    <div flow-init="{target: '@api.routes.Files.create(path)'}"
         flow-files-submitted="$flow.upload()"
         flow-file-success="$file.msg = $message"
         class="pull-right">

      <span class="btn btn-success" flow-btn>
        <i class="fa fa-upload"></i>
        <strong>Upload new file</strong>
      </span>
    </div>
  </div>

}()(
  libs.webjars("js", "angular-resource"),
  libs.webjars("js", "ng-flow"),
  libs.webjars("js", "xeditable"),
  libs.assets("js", "api"),
  libs.assets("js", "ui.parts"),
  libs.assets("js", "files/index"),
  jsRoutes,
  controller
)

@jsRoutes = {
  @helper.javascriptRouter("jsRoutes")(
    routes.javascript.Files.index,
    routes.javascript.Files.show,
    api.routes.javascript.Files.download,
    api.routes.javascript.Files.destroy
  )
}

@controller = {
  <script>
    views.files.index.run(['FileList', function(FileList) {
      FileList.reload({
        page     : @page.pager.pageNum,
        pageSize : @page.pager.pageSize,
        nextPage : '@Html(routes.Files.index(path,page.pager.next).toString)',
        prevPage : '@Html(routes.Files.index(path,page.pager.prev).toString)',
        userId   : '@req.user.id',
        path     : @Html(path.toJson.toString)
      });
    }]);
  </script>
}