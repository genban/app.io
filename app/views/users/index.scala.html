@(pager: Pager)(
implicit req: UserRequest[_], lang: Lang)

@import common._
@import helper._

@layouts.base(Users.vmsg("title")) {

  <div class="ng-cloak" ng-controller="AlertCtrl">
    <alert ng-repeat="alert in Alert.alerts" type="{{alert.type}}" close="Alert.dismiss($index)">{{alert.msg}}</alert>
  </div>

  <div class="row" style="margin-top:10px">
    <h2 style="margin-left: 20px">
      <i class="fa fa-user fa-lg fa-fw"></i>
      @Users.vmsg("head")
    </h2>
  </div>

  <div ng-controller="UsersCtrl">

    <div class="row">
      <div class="col-xs-8 col-xs-offset-4 col-sm-6 col-sm-offset-6">
        <div class="form-group">
          <label class="sr-only" for="search-users">
            @Users.vmsg("search.label")
          </label>
          <div class="input-group">
            <div class="input-group-addon">
              <i class="fa fa-search"></i>
            </div>
            <input type="search" class="form-control" id="search-users"
              placeholder="@Users.vmsg("search.label")"
              autocomplete="off"
              ng-model="keyword">
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="table-responsive">
        <table class="table table-hover table-ellipsis">
          <thead>
            <tr>
              <th class="hidden-xs col-sm-6  col-md-5">
                @MSG("id")
              </th>
              <th class="col-xs-8  col-sm-3  col-md-3">
                @MSG("email")
              </th>
              <th class="hidden-xs hidden-sm col-md-3">
                @MSG("name")
              </th>
              <th class="col-xs-4  col-sm-3  col-md-1 text-right">
                @MSG("action")
              </th>
            </tr>
          </thead>
          <tbody>
            <tr class="ng-cloak" ng-repeat="usr in UserList.users">
              <td class="hidden-xs">
                <a ng-href="{{jsRoutes.controllers.Users.show(usr.id).url}}">
                  <code>{{ usr.id }}</code>
                </a>
              </td>
              <td class="hidden-xs">
                {{ usr.email }}
              </td>
              <td class="visible-xs">
                <a ng-href="{{jsRoutes.controllers.Users.show(usr.id).url}}">
                  {{ usr.email }}
                </a>
              </td>
              <td class="hidden-xs hidden-sm">
                {{ usr.name }}
              </td>
              <td>
                <div class="pull-right">
                  <i class="fa fa-unlock-alt fa-lg fa-fw"></i>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-12">
        <form name="form" class="form-inline" novalidate>

          @ng._form_control("email",
            '_type        -> "email",
            'email        -> None,
            'tabindex     -> 1,
            'placeholder  -> Users.vmsg("email.placeholder"),
            'autocomplete -> "off",
            Symbol("ng-model") -> "user.email"
          )

          @ng._form_control("name",
            'maxLength    -> 64,
            'minLength    -> 2,
            'tabindex    -> 2,
            'placeholder -> Users.vmsg("name.placeholder"),
            Symbol("ng-model") -> "user.name"
          )

          <button type="submit" class="btn btn-success" ng-click="UserList.create(user)"
            ng-disabled="form.$invalid || !user.email || user.email === '' || !user.name || user.name === ''">
            <i class="fa fa-user-plus"></i>
            @Users.vmsg("new.user")
          </button>
        </form>
      </div>
    </div>

    <div class="row" ng-hide="keyword !== ''">
      @ng._pager("UserList.links")
    </div>
  </div>
}()(
  libs.webjars("js", "angular-resource"),
  libs.assets("js", "api"),
  jsRoutes,
  controller
)

@jsRoutes = {
  @helper.javascriptRouter("jsRoutes")(
    routes.javascript.Users.show
  )
}

@controller = {
  <script>
    var list = angular.module('users.list',
      ['ui.bootstrap', 'api.user', 'api.helper']);

    list.factory('UserList',
      ['User', 'LinkHeader', 'Alert',
      function(User, LinkHeader, Alert){
        var service = {};
        service.links = LinkHeader.links;

        service.users = {};

        service.reload = function(q) {
          service.users = User.query({
          page     :@pager.pageNum,
          per_page :@pager.pageSize,
          q        :( !q ? '' : '*' + q + '*')
          }, function(value, headers){
            LinkHeader.updateLinks(
              '@Html(routes.Users.index(pager.next).toString)',
              '@Html(routes.Users.index(pager.prev).toString)',
              headers);
          });
        };

        service.reload();

        service.create = function(data) {
          new User(data).$save(function(value){
            service.users.unshift(value);
          },function(res) {
            Alert.push({type:'danger', msg:res.data.message});
          });
        };

        return service;
    }])

    .controller('UsersCtrl',
      ['$scope', 'UserList',
      function ($scope, UserList) {
        $scope.UserList = UserList;
        $scope.jsRoutes = jsRoutes;

        $scope.keyword = '';

        $scope.$watch('keyword', function(nv, ov) {
          UserList.reload(nv);
        });
    }])
    .controller('AlertCtrl',['$scope', 'Alert', function($scope, Alert) {
      $scope.Alert = Alert;
    }]);

    angular.module('app').requires.push('users.list');
  </script>
}